<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAW Labour Hire - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-active { border-bottom: 3px solid #1E3A8A; color: #1E3A8A; }
        .status-draft { background: #F3F4F6; color: #6B7280; }
        .status-submitted { background: #FEF3C7; color: #92400E; }
        .status-approved { background: #D1FAE5; color: #065F46; }
        .status-rejected { background: #FEE2E2; color: #991B1B; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1E3A8A; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .signature-img { max-width: 300px; border: 1px solid #E5E7EB; border-radius: 8px; background: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="raw-logo.png" alt="RAW Logo" class="h-10 w-10 object-contain bg-white rounded p-1" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-xl font-bold">RAW Labour Hire</h1>
                    <p class="text-blue-200 text-sm">Admin Dashboard</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="lastUpdated" class="text-sm text-blue-200"></span>
                <button onclick="refreshData()" class="bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex gap-8">
                <button onclick="switchTab('timesheets')" id="tab-timesheets" class="py-4 px-2 font-medium tab-active">
                    <i class="fas fa-clock mr-2"></i>Timesheets
                </button>
                <button onclick="switchTab('workers')" id="tab-workers" class="py-4 px-2 font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-users mr-2"></i>Workers
                </button>
                <button onclick="switchTab('clients')" id="tab-clients" class="py-4 px-2 font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-building mr-2"></i>Clients & Job Sites
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Timesheets Tab -->
        <div id="content-timesheets">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Pending Approval</p>
                            <p id="stat-pending" class="text-2xl font-bold text-yellow-600">-</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-hourglass-half text-yellow-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Approved This Week</p>
                            <p id="stat-approved" class="text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Hours This Week</p>
                            <p id="stat-hours" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-clock text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Active Workers</p>
                            <p id="stat-workers" class="text-2xl font-bold text-purple-600">-</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-user-check text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-white rounded-xl shadow p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Status</label>
                        <select id="filter-status" onchange="loadTimesheets()" class="border rounded-lg px-3 py-2">
                            <option value="">All Statuses</option>
                            <option value="submitted" selected>Pending Approval</option>
                            <option value="approved">Approved</option>
                            <option value="draft">Draft</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Worker</label>
                        <select id="filter-worker" onchange="loadTimesheets()" class="border rounded-lg px-3 py-2">
                            <option value="">All Workers</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Timesheets Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Docket #</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Worker</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Week</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Client</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Hours</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="timesheets-table" class="divide-y divide-gray-100">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <div class="loader mx-auto mb-2"></div>Loading timesheets...
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Workers Tab -->
        <div id="content-workers" class="hidden">
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Workers Directory</h2>
                    <button onclick="openAddWorkerModal()" class="bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800">
                        <i class="fas fa-plus mr-2"></i>Add Worker
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Name</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Email</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Phone</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Type</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Emergency Contact</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workers-table" class="divide-y divide-gray-100">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <div class="loader mx-auto mb-2"></div>Loading workers...
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="content-clients" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Clients -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-lg font-semibold">Clients</h2>
                        <button onclick="openAddClientModal()" class="bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800">
                            <i class="fas fa-plus mr-2"></i>Add Client
                        </button>
                    </div>
                    <div id="clients-list" class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                        <div class="px-4 py-8 text-center text-gray-500">
                            <div class="loader mx-auto mb-2"></div>Loading clients...
                        </div>
                    </div>
                </div>

                <!-- Job Sites -->
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-lg font-semibold">Job Sites</h2>
                        <button onclick="openAddJobSiteModal()" class="bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800">
                            <i class="fas fa-plus mr-2"></i>Add Job Site
                        </button>
                    </div>
                    <div id="jobsites-list" class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                        <div class="px-4 py-8 text-center text-gray-500">
                            <div class="loader mx-auto mb-2"></div>Loading job sites...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Timesheet Detail Modal -->
    <div id="timesheet-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Timesheet Details</h2>
                    <p id="modal-docket" class="text-gray-500">Docket #12345</p>
                </div>
                <button onclick="closeModal('timesheet-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Content loaded dynamically -->
            </div>
            <div id="modal-actions" class="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex gap-4 justify-end">
                <!-- Actions loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Worker Modal -->
    <div id="add-worker-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold">Add New Worker</h2>
                <button onclick="closeModal('add-worker-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="add-worker-form" onsubmit="submitAddWorker(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">First Name *</label>
                        <input type="text" name="first_name" required class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Surname *</label>
                        <input type="text" name="surname" required class="w-full border rounded-lg px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email *</label>
                    <input type="email" name="email" required class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Phone</label>
                    <input type="tel" name="phone" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Employment Type</label>
                    <select name="employment_type" class="w-full border rounded-lg px-3 py-2">
                        <option value="casual">Casual</option>
                        <option value="full_time">Full Time</option>
                        <option value="part_time">Part Time</option>
                    </select>
                </div>
                <div class="pt-4 border-t flex gap-4 justify-end">
                    <button type="button" onclick="closeModal('add-worker-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800">Add Worker</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold">Add New Client</h2>
                <button onclick="closeModal('add-client-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="add-client-form" onsubmit="submitAddClient(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Company Name *</label>
                    <input type="text" name="name" required class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Contact Name</label>
                    <input type="text" name="contact_name" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Contact Email</label>
                    <input type="email" name="contact_email" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Contact Phone</label>
                    <input type="tel" name="contact_phone" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address</label>
                    <textarea name="address" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
                <div class="pt-4 border-t flex gap-4 justify-end">
                    <button type="button" onclick="closeModal('add-client-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800">Add Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Job Site Modal -->
    <div id="add-jobsite-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold">Add New Job Site</h2>
                <button onclick="closeModal('add-jobsite-modal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="add-jobsite-form" onsubmit="submitAddJobSite(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Site Name *</label>
                    <input type="text" name="name" required class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Client *</label>
                    <select name="client_id" id="jobsite-client-select" required class="w-full border rounded-lg px-3 py-2">
                        <option value="">Select Client</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address *</label>
                    <textarea name="address" required rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Site Contact Name</label>
                    <input type="text" name="contact_name" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Site Contact Phone</label>
                    <input type="tel" name="contact_phone" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="pt-4 border-t flex gap-4 justify-end">
                    <button type="button" onclick="closeModal('add-jobsite-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800">Add Job Site</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let allTimesheets = [];
        let allWorkers = [];
        let allClients = [];
        let allJobSites = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
        });

        async function refreshData() {
            document.getElementById('lastUpdated').textContent = 'Updating...';
            await Promise.all([
                loadTimesheets(),
                loadWorkers(),
                loadClients(),
                loadJobSites()
            ]);
            document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');

            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        // ==================== TIMESHEETS ====================

        async function loadTimesheets() {
            const status = document.getElementById('filter-status').value;
            const workerId = document.getElementById('filter-worker').value;
            
            try {
                let url = `${API_BASE}/timesheets/admin/all`;
                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (workerId) params.append('worker_id', workerId);
                if (params.toString()) url += `?${params.toString()}`;

                const response = await fetch(url);
                const data = await response.json();
                allTimesheets = data.timesheets || [];
                renderTimesheets();
                updateStats();
            } catch (error) {
                console.error('Error loading timesheets:', error);
                document.getElementById('timesheets-table').innerHTML = 
                    `<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Error loading timesheets</td></tr>`;
            }
        }

        function renderTimesheets() {
            const tbody = document.getElementById('timesheets-table');
            
            if (allTimesheets.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No timesheets found</td></tr>`;
                return;
            }

            tbody.innerHTML = allTimesheets.map(ts => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <span class="font-mono text-sm font-medium">#${ts.docket_number}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium">${ts.worker_name || 'Unknown'}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${formatDate(ts.week_starting)} - ${formatDate(ts.week_ending)}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${ts.client_name || '-'}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium">${(ts.total_hours || 0).toFixed(1)}h</div>
                        <div class="text-xs text-gray-500">${(ts.total_overtime_hours || 0).toFixed(1)}h OT</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium status-${ts.status}">
                            ${ts.status.charAt(0).toUpperCase() + ts.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="viewTimesheet(${ts.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const pending = allTimesheets.filter(ts => ts.status === 'submitted').length;
            const approved = allTimesheets.filter(ts => ts.status === 'approved').length;
            const totalHours = allTimesheets.reduce((sum, ts) => sum + (ts.total_hours || 0), 0);
            
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-approved').textContent = approved;
            document.getElementById('stat-hours').textContent = totalHours.toFixed(1);
            document.getElementById('stat-workers').textContent = allWorkers.length;
        }

        async function viewTimesheet(id) {
            try {
                const response = await fetch(`${API_BASE}/timesheets/${id}`);
                const ts = await response.json();
                
                document.getElementById('modal-docket').textContent = `Docket #${ts.docket_number}`;
                
                const entriesHtml = (ts.entries || []).map(entry => `
                    <div class="border rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-medium">${entry.day_of_week}</span>
                                <span class="text-gray-500 text-sm ml-2">${formatDate(entry.entry_date)}</span>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-medium status-${entry.entry_status || 'draft'}">
                                ${(entry.entry_status || 'draft').charAt(0).toUpperCase() + (entry.entry_status || 'draft').slice(1)}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Time</p>
                                <p>${formatTime(entry.clock_in_time)} - ${formatTime(entry.clock_out_time)}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Hours</p>
                                <p>${(entry.total_hours || 0).toFixed(2)}h (${(entry.overtime_hours || 0).toFixed(2)}h OT)</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Role</p>
                                <p>${entry.worked_as || '-'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Location</p>
                                <p class="truncate" title="${entry.clock_in_address || '-'}">${entry.clock_in_address || '-'}</p>
                            </div>
                        </div>
                        ${entry.supervisor_name ? `
                            <div class="mt-3 pt-3 border-t">
                                <p class="text-sm text-gray-500">Supervisor: ${entry.supervisor_name} (${entry.supervisor_contact || '-'})</p>
                                ${entry.supervisor_signature ? `
                                    <img src="${entry.supervisor_signature}" alt="Signature" class="signature-img mt-2">
                                ` : ''}
                            </div>
                        ` : ''}
                        ${entry.comments ? `
                            <div class="mt-2 text-sm text-gray-600">
                                <i class="fas fa-comment-alt mr-1"></i> ${entry.comments}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                document.getElementById('modal-content').innerHTML = `
                    <div class="mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-500">Worker</p>
                                <p class="font-medium">${ts.worker_name || 'Unknown'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Client</p>
                                <p class="font-medium">${ts.client_name || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Total Hours</p>
                                <p class="font-medium">${(ts.total_hours || 0).toFixed(2)}h</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Overtime</p>
                                <p class="font-medium">${(ts.total_overtime_hours || 0).toFixed(2)}h</p>
                            </div>
                        </div>
                        ${ts.supervisor_signature ? `
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <p class="text-sm text-gray-500 mb-2">Supervisor Approval</p>
                                <p class="font-medium">${ts.supervisor_name || '-'} | ${ts.supervisor_contact || '-'}</p>
                                <img src="${ts.supervisor_signature}" alt="Signature" class="signature-img mt-2">
                            </div>
                        ` : ''}
                    </div>
                    <h3 class="font-semibold mb-3">Daily Entries</h3>
                    ${entriesHtml || '<p class="text-gray-500">No entries</p>'}
                `;

                // Show appropriate actions based on status
                let actionsHtml = '';
                if (ts.status === 'submitted') {
                    actionsHtml = `
                        <button onclick="rejectTimesheet(${ts.id})" class="px-4 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50">
                            <i class="fas fa-times mr-2"></i>Reject
                        </button>
                        <button onclick="approveTimesheet(${ts.id})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>Approve
                        </button>
                    `;
                } else if (ts.status === 'approved') {
                    actionsHtml = `<span class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Approved</span>`;
                } else if (ts.status === 'rejected') {
                    actionsHtml = `<span class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Rejected</span>`;
                }
                document.getElementById('modal-actions').innerHTML = actionsHtml;

                openModal('timesheet-modal');
            } catch (error) {
                console.error('Error loading timesheet:', error);
                alert('Error loading timesheet details');
            }
        }

        async function approveTimesheet(id) {
            if (!confirm('Approve this timesheet?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/timesheets/${id}/approve`, {
                    method: 'POST'
                });
                if (response.ok) {
                    closeModal('timesheet-modal');
                    await loadTimesheets();
                    alert('Timesheet approved!');
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Error approving timesheet');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error approving timesheet');
            }
        }

        async function rejectTimesheet(id) {
            const reason = prompt('Reason for rejection (optional):');
            if (reason === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/timesheets/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (response.ok) {
                    closeModal('timesheet-modal');
                    await loadTimesheets();
                    alert('Timesheet rejected');
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Error rejecting timesheet');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error rejecting timesheet');
            }
        }

        // ==================== WORKERS ====================

        async function loadWorkers() {
            try {
                const response = await fetch(`${API_BASE}/users/admin/workers`);
                const data = await response.json();
                allWorkers = data.workers || [];
                renderWorkers();
                populateWorkerFilter();
            } catch (error) {
                console.error('Error loading workers:', error);
            }
        }

        function renderWorkers() {
            const tbody = document.getElementById('workers-table');
            
            if (allWorkers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No workers found</td></tr>`;
                return;
            }

            tbody.innerHTML = allWorkers.map(w => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="font-medium">${w.first_name} ${w.surname}</div>
                    </td>
                    <td class="px-4 py-3">${w.email}</td>
                    <td class="px-4 py-3">${w.phone || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="capitalize">${(w.employment_type || 'casual').replace('_', ' ')}</span>
                    </td>
                    <td class="px-4 py-3">
                        ${w.emergency_contact_name ? `
                            <div class="text-sm">${w.emergency_contact_name}</div>
                            <div class="text-xs text-gray-500">${w.emergency_contact_phone || ''}</div>
                        ` : '<span class="text-yellow-600 text-sm">Not set</span>'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${w.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${w.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="viewWorker(${w.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${w.is_active ? `
                            <button onclick="deactivateWorker(${w.id})" class="text-red-600 hover:text-red-800" title="Deactivate">
                                <i class="fas fa-user-slash"></i>
                            </button>
                        ` : `
                            <button onclick="activateWorker(${w.id})" class="text-green-600 hover:text-green-800" title="Activate">
                                <i class="fas fa-user-check"></i>
                            </button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function populateWorkerFilter() {
            const select = document.getElementById('filter-worker');
            select.innerHTML = '<option value="">All Workers</option>' +
                allWorkers.map(w => `<option value="${w.id}">${w.first_name} ${w.surname}</option>`).join('');
        }

        function openAddWorkerModal() {
            document.getElementById('add-worker-form').reset();
            openModal('add-worker-modal');
        }

        async function submitAddWorker(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE}/users/admin/workers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    closeModal('add-worker-modal');
                    await loadWorkers();
                    alert(`Worker added! Temporary password: ${result.temp_password}\n\nShare this with the worker so they can log in.`);
                } else {
                    alert(result.detail || 'Error adding worker');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding worker');
            }
        }

        async function viewWorker(id) {
            alert('Worker details view coming soon');
        }

        async function activateWorker(id) {
            if (!confirm('Activate this worker?')) return;
            try {
                await fetch(`${API_BASE}/users/admin/workers/${id}/activate`, { method: 'PATCH' });
                await loadWorkers();
            } catch (error) {
                alert('Error activating worker');
            }
        }

        async function deactivateWorker(id) {
            if (!confirm('Deactivate this worker?')) return;
            try {
                await fetch(`${API_BASE}/users/admin/workers/${id}/deactivate`, { method: 'PATCH' });
                await loadWorkers();
            } catch (error) {
                alert('Error deactivating worker');
            }
        }

        // ==================== CLIENTS ====================

        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/clients/`);
                const data = await response.json();
                allClients = data.clients || [];
                renderClients();
                populateClientSelect();
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function renderClients() {
            const container = document.getElementById('clients-list');
            
            if (allClients.length === 0) {
                container.innerHTML = `<div class="px-4 py-8 text-center text-gray-500">No clients yet</div>`;
                return;
            }

            container.innerHTML = allClients.map(c => `
                <div class="p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium">${c.name}</div>
                            ${c.contact_name ? `<div class="text-sm text-gray-500">${c.contact_name}</div>` : ''}
                            ${c.contact_email ? `<div class="text-sm text-gray-500">${c.contact_email}</div>` : ''}
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${c.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                            ${c.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function populateClientSelect() {
            const select = document.getElementById('jobsite-client-select');
            select.innerHTML = '<option value="">Select Client</option>' +
                allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function openAddClientModal() {
            document.getElementById('add-client-form').reset();
            openModal('add-client-modal');
        }

        async function submitAddClient(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE}/clients/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal('add-client-modal');
                    await loadClients();
                    alert('Client added!');
                } else {
                    const result = await response.json();
                    alert(result.detail || 'Error adding client');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding client');
            }
        }

        // ==================== JOB SITES ====================

        async function loadJobSites() {
            try {
                const response = await fetch(`${API_BASE}/clients/job-sites/all`);
                const data = await response.json();
                allJobSites = data.job_sites || [];
                renderJobSites();
            } catch (error) {
                console.error('Error loading job sites:', error);
            }
        }

        function renderJobSites() {
            const container = document.getElementById('jobsites-list');
            
            if (allJobSites.length === 0) {
                container.innerHTML = `<div class="px-4 py-8 text-center text-gray-500">No job sites yet</div>`;
                return;
            }

            container.innerHTML = allJobSites.map(js => `
                <div class="p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium">${js.name}</div>
                            <div class="text-sm text-blue-600">${js.client_name || '-'}</div>
                            <div class="text-sm text-gray-500">${js.address}</div>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${js.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                            ${js.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function openAddJobSiteModal() {
            document.getElementById('add-jobsite-form').reset();
            openModal('add-jobsite-modal');
        }

        async function submitAddJobSite(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.client_id = parseInt(data.client_id);

            try {
                const response = await fetch(`${API_BASE}/jobsites/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal('add-jobsite-modal');
                    await loadJobSites();
                    alert('Job site added!');
                } else {
                    const result = await response.json();
                    alert(result.detail || 'Error adding job site');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding job site');
            }
        }

        // ==================== UTILITIES ====================

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        }

        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            if (timeStr.includes('T')) {
                const date = new Date(timeStr);
                return date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
            }
            return timeStr.substring(0, 5);
        }
    </script>
</body>
</html>
